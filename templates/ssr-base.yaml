templates/ssr-base.yaml{% extends 'base.yaml' %}

{%- block write_files %}
{%- if root_ssh_keys %}
- path: /home/t128/.ssh/authorized_keys
  permissions: '0600'
  owner: t128:t128
  content: |
    {%- for key in root_ssh_keys %}
    {{ key }}
    {%- endfor %}
{% endif -%}
- path: /root/change_admin_password.py
  permissions: '0700'
  content: |
    #!/usr/bin/env python3
    import requests

    BASE_URL = "https://localhost"
    DEFAULT_PASSWORD = "{{ passwords['admin'].default }}"
    ADMIN_PASSWORD = "{{ passwords['admin'].plain }}"

    def main():
        with requests.Session() as session:
            session.verify = False

            login_payload = {
                "username": "admin",
                "password": DEFAULT_PASSWORD,
            }
            login_url = BASE_URL + '/api/v1/login'
            login_response = session.post(login_url, json=login_payload)

            if login_response.status_code == 200:
                session.headers['Authorization'] = f'Bearer {login_response.json()["token"]}'

                admin_patch_payload = {
                    "password": ADMIN_PASSWORD,
                    "oldPassword": DEFAULT_PASSWORD,
                }
                patch_url = BASE_URL + '/api/v1/user/admin'
                patch_response = session.patch(patch_url, json=admin_patch_payload)

    if __name__ == "__main__":
        main()
{%- endblock %}

{% block runcmd -%}
{%- if root_ssh_key_url -%}
- cat /root/.ssh/authorized_keys > /home/t128/.ssh/authorized_keys
{%- endif %}
- chown t128:t128 /home/t128/.ssh
- sed -i -e '/^AllowGroups/s/$/ root/' -e '/^PermitRootLogin/s/no/yes/' -e '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config; systemctl restart sshd
- usermod --password '{{ passwords['t128'].hash }}' t128
- 'echo vm_type: {{ vm_type }} >> /etc/salt/grains'
{% block extra_runcmd -%}
- cloud-init devel net-convert -k yaml -p /root/network.yaml -d / -D centos -O sysconfig
- for interface in $(cd /etc/sysconfig/network-scripts/; ls -1 ifcfg-eth* | sed 's/ifcfg-//'); do ifdown $interface; ifup $interface; done
- {% if vm_type == "ssr-router" %}lvdisplay /dev/vg00/altroot > /dev/null 2>&1 || {% endif %}initialize128t -p /root/initializer-preferences.json
- systemctl enable 128T; systemctl start 128T
{%- endblock %}
{%- endblock %}
