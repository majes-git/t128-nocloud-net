{% extends 'base.yaml' %}

{%- block write_files %}
{%- if root_ssh_keys %}
- path: /home/t128/.ssh/authorized_keys
  permissions: '0600'
  owner: t128:t128
  content: |
    {%- for key in root_ssh_keys %}
    {{ key }}
    {%- endfor %}
{% endif -%}
- path: /root/.bash_history
  content: |
    stty cols 200 rows 50
    su admin
- path: /etc/cron.d/change-default-admin-password
  content: |
    # renew letsencrypt web certificate
    */5 * * * *     root /usr/local/sbin/change-default-admin-password.bash
- path: /usr/local/sbin/change-default-admin-password.bash
  permissions: '0700'
  content: |
    #!/bin/bash

    # get current admin password
    current=$(sed -n 's|.*"admin",[[:space:]]\?"password":[[:space:]]\?"\([^"]\+\).*|\1|p' /var/lib/128technology/user-running.json)

    # if admin password is not default - there is nothing to do ...
    /usr/local/sbin/verify_sha512.pyz -p "{{ passwords['admin'].default }}" -h "$current" || exit 0

    # ... otherwise change the password
    /usr/local/sbin/change-ssr-passwd.pyz -o "{{ passwords['admin'].default }}" -n "{{ passwords['admin'].plain }}"
{%- endblock %}

{% block runcmd -%}
{%- if root_ssh_key_url -%}
- cat /root/.ssh/authorized_keys > /home/t128/.ssh/authorized_keys
{%- endif %}
- chown t128:t128 /home/t128/.ssh
- sed -i -e '/^AllowGroups/s/$/ root/' -e '/^PermitRootLogin/s/no/yes/' -e '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config; systemctl restart sshd
- usermod --password '{{ passwords['t128'].hash }}' t128
- 'echo vm_type: {{ vm_type }} >> /etc/salt/grains'
- (cd /usr/local/sbin; curl -JLO https://github.com/majes-git/passwd/raw/refs/heads/main/verify_sha512.pyz; curl -JLO https://github.com/majes-git/ssr-scripts/raw/refs/heads/main/change-ssr-passwd.pyz; chmod +x *.pyz)
{% block extra_runcmd -%}
- cloud-init devel net-convert -k yaml -p /root/network.yaml -d / -D centos -O sysconfig
- for interface in $(cd /etc/sysconfig/network-scripts/; ls -1 ifcfg-eth* | sed 's/ifcfg-//'); do ifdown $interface; ifup $interface; done
- {% if vm_type == "ssr-router" %}lvdisplay /dev/vg00/altroot > /dev/null 2>&1 || {% endif %}initialize128t -p /root/initializer-preferences.json
- systemctl enable 128T; systemctl start 128T
{%- endblock %}
{%- endblock %}
